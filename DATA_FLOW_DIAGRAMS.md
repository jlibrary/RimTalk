# RimTalk 数据流程图 (Data Flow Diagrams)

## 1. 完整对话生成流程 (Complete Conversation Generation Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           游戏事件 (Game Events)                              │
│  - Pawn 获得新想法 (New thought)                                              │
│  - 技能提升 (Skill level up)                                                  │
│  - 战斗事件 (Battle events)                                                   │
│  - 精神崩溃 (Mental break)                                                    │
│  - 用户自定义对话 (User-initiated dialogue)                                    │
└──────────────────────────────┬──────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Harmony Patches (游戏事件拦截)                           │
│  - ThoughtPatch, SkillLearnPatch, BattleLogPatch, etc.                      │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ PawnState.AddTalkRequest(prompt, recipient, talkType)       │            │
│  └────────────────────────────┬─────────────────────────────────┘            │
└───────────────────────────────┼──────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TalkService.GenerateTalk() ★ 可替换                       │
│                                                                               │
│  决策逻辑 (Decision Logic):                                                   │
│  ✓ 检查 mod 是否启用                                                          │
│  ✓ 检查 AI 是否繁忙                                                          │
│  ✓ 检查 pawn 是否符合条件                                                     │
│  ✓ 验证接收者                                                                │
│  ✓ 检测危险情况                                                              │
│  ✓ 选择对话参与者                                                            │
│                                                                               │
│  如果通过所有检查 →                                                           │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              游戏信息提取 (Game Information Extraction) ★ 保留                │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ PromptService.BuildContext(List<Pawn> pawns)                │            │
│  │   ├─ CreatePawnBackstory(pawn)                              │            │
│  │   │   ├─ 姓名、头衔、性别、年龄                              │            │
│  │   │   ├─ 角色 (Colonist/Prisoner/Slave/etc.)                │            │
│  │   │   ├─ 种族、基因 (if Biotech)                            │            │
│  │   │   ├─ 意识形态 (if Ideology)                             │            │
│  │   │   ├─ 童年/成年背景                                        │            │
│  │   │   ├─ 特质 (Traits)                                       │            │
│  │   │   └─ 技能 (Skills)                                       │            │
│  │   ├─ CreatePawnContext(pawn)                                │            │
│  │   │   ├─ Backstory (上面的)                                  │            │
│  │   │   ├─ 健康状态 (Health/Hediffs)                           │            │
│  │   │   ├─ 个性 (Personality from Cache)                      │            │
│  │   │   ├─ 心情 (Mood)                                         │            │
│  │   │   ├─ 想法/记忆 (Thoughts via GetThoughts())             │            │
│  │   │   ├─ 关系 (Relations via RelationsService)             │            │
│  │   │   └─ 装备 (Equipment)                                    │            │
│  │   └─ 格式化为 [Person N START]...[Person N END]            │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ PawnService.GetPawnStatusFull(pawn, nearbyPawns)            │            │
│  │   ├─ 当前活动 (Activity via GetActivity())                   │            │
│  │   ├─ 附近的人 (Nearby pawns and their status)                │            │
│  │   ├─ 威胁信息 (Hostile pawns via GetHostilePawnNearBy())    │            │
│  │   ├─ 访客/入侵者状态                                          │            │
│  │   └─ 返回 (statusString, isInDanger)                        │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  输出: string context, string status                                          │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               最终提示词生成 (Final Prompt Generation) ★ 保留                 │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ PromptService.DecoratePrompt(request, pawns, status)        │            │
│  │                                                              │            │
│  │  构建最终提示词:                                              │            │
│  │  ├─ 对话格式说明 (基于 TalkType)                             │            │
│  │  │   ├─ User: "A voice from beyond says..."                │            │
│  │  │   ├─ Monologue: "X short monologue"                     │            │
│  │  │   ├─ Combat: "X dialogue short, urgent tone"            │            │
│  │  │   └─ Normal: "X starts conversation, taking turns"     │            │
│  │  ├─ Pawn 状态 (status 参数)                                 │            │
│  │  ├─ 位置 (Location: Indoor/Outdoor)                         │            │
│  │  ├─ 时间 (Time: 12-hour format)                             │            │
│  │  ├─ 日期 (Date)                                             │            │
│  │  ├─ 季节 (Season)                                           │            │
│  │  ├─ 天气 (Weather)                                          │            │
│  │  └─ 语言说明 (Language, if first instruction)              │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  输出: 更新 request.Prompt                                                    │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       LLM API 调用 (LLM API Call) ★ 保留                     │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ AIService.UpdateContext(context)                            │            │
│  │  └─ 存储系统提示词/上下文                                     │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ TalkHistory.GetMessageHistory(initiator)                    │            │
│  │  └─ 获取对话历史作为上下文                                    │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ AIService.ChatStreaming() 或 Chat()                         │            │
│  │  ├─ AIClientFactory.GetAIClient()                           │            │
│  │  │   └─ 根据配置创建客户端                                   │            │
│  │  │       ├─ OpenAIClient (OpenAI, DeepSeek, OpenRouter)    │            │
│  │  │       ├─ GeminiClient (Google Gemini)                   │            │
│  │  │       └─ Custom/Local clients                           │            │
│  │  ├─ client.GetStreamingChatCompletionAsync()               │            │
│  │  │   └─ 发送请求到 LLM API                                  │            │
│  │  └─ 解析流式响应或完整响应                                   │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  输出: List<TalkResponse> 或流式回调                                          │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               响应处理与队列管理 (Response Processing) ★ 可替换               │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ TalkService.GenerateAndProcessTalkAsync()                   │            │
│  │  ├─ 处理每个 TalkResponse                                     │            │
│  │  ├─ 设置 ParentTalkId (链接回复)                             │            │
│  │  ├─ 添加到 PawnState.TalkResponses 队列                      │            │
│  │  └─ TalkHistory.AddMessageHistory() (保存历史)              │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  输出: 对话响应在每个 pawn 的队列中                                           │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                   对话显示 (Dialogue Display) ★ 部分可替换                    │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ TalkService.DisplayTalk() (每个游戏 tick 调用)              │            │
│  │  ├─ 遍历所有 pawns 的 TalkResponses 队列                      │            │
│  │  ├─ 检查是否应该显示 (时机、间隔、父对话等)                   │            │
│  │  ├─ 创建 PlayLogEntry_RimTalkInteraction                    │            │
│  │  └─ Find.PlayLog.Add() (触发显示)                           │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ TalkService.GetTalk(pawn) (游戏 UI 调用)                    │            │
│  │  ├─ 从队列中取出对话                                          │            │
│  │  ├─ ConsumeTalk() (标记为已说出)                            │            │
│  │  └─ 返回对话文本                                             │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     游戏内显示 (In-Game Display) ★ 保留                       │
│  - BubblePatch: 在 pawn 头上显示对话气泡                                      │
│  - ArchivePatch: 在历史日志中记录                                            │
│  - 对话文本显示在屏幕上                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 用户自定义对话流程 (User-Initiated Dialogue Flow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        用户操作 (User Action)                                │
│  - 右键点击 pawn                                                              │
│  - 选择 "Talk to..." 菜单项                                                   │
└──────────────────────────────┬──────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     FloatMenuPatch (Harmony Patch)                           │
│  - 添加 "Talk to self" 或 "Talk to [other pawn]" 菜单项                      │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     CustomDialogueWindow (UI) ★ 保留                         │
│  ┌─────────────────────────────────────────────────────────┐                 │
│  │  ╔═══════════════════════════════════════════════════╗  │                 │
│  │  ║  What should John say to Mary?                   ║  │                 │
│  │  ║  ┌───────────────────────────────────────────┐   ║  │                 │
│  │  ║  │ [用户输入文本框]                           │   ║  │                 │
│  │  ║  └───────────────────────────────────────────┘   ║  │                 │
│  │  ║  ┌──────────┐  ┌──────────┐                      ║  │                 │
│  │  ║  │   Send   │  │  Cancel  │                      ║  │                 │
│  │  ║  └──────────┘  └──────────┘                      ║  │                 │
│  │  ╚═══════════════════════════════════════════════════╝  │                 │
│  └─────────────────────────────────────────────────────────┘                 │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                  CustomDialogueService ★ 保留                                │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ CanTalk(initiator, recipient)                               │            │
│  │  ├─ 检查距离 (≤ 20 tiles)                                    │            │
│  │  └─ 检查是否在同一房间                                        │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  如果可以对话 →                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ ExecuteDialogue(initiator, recipient, message)              │            │
│  │  ├─ 创建 TalkRequest (TalkType.User)                         │            │
│  │  ├─ 添加到 recipientState.TalkRequests (优先)                │            │
│  │  ├─ 创建 TalkResponse 给 initiator 显示                      │            │
│  │  └─ ApiHistory.AddUserHistory() (记录用户输入)              │            │
│  └──────────────────────────────────────────────────────────────┘            │
│                                                                               │
│  如果不能对话 →                                                               │
│  ┌──────────────────────────────────────────────────────────────┐            │
│  │ 添加到 PendingDialogues                                      │            │
│  │ 创建 Goto Job (让 pawn 走向目标)                             │            │
│  └──────────────────────────────────────────────────────────────┘            │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
                        (继续正常的对话生成流程)
```

## 3. 状态管理架构 (State Management Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Cache (全局状态管理) ★ 可替换                       │
│                                                                               │
│  Dictionary<Pawn, PawnState>                                                 │
│                                                                               │
│  方法:                                                                        │
│  ├─ Get(Pawn): 获取或创建 PawnState                                           │
│  ├─ Keys: 所有被跟踪的 pawns                                                  │
│  ├─ GetAll(): 所有 PawnStates                                                │
│  └─ 清理: 移除无效的 pawns                                                    │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       PawnState (每个 pawn 的状态) ★ 可替换                   │
│                                                                               │
│  字段:                                                                        │
│  ├─ Pawn: 关联的 pawn                                                         │
│  ├─ Context: 从 PromptService 生成的上下文字符串                              │
│  ├─ LastTalkTick: 上次说话的游戏 tick                                         │
│  ├─ LastStatus: 上次状态字符串 (用于避免重复)                                 │
│  ├─ RejectCount: 连续拒绝计数                                                │
│  ├─ IsGeneratingTalk: 是否正在生成对话                                        │
│  ├─ TalkResponses: Queue<TalkResponse> 待显示的对话                          │
│  ├─ TalkRequests: LinkedList<TalkRequest> 待生成的请求                       │
│  ├─ Hediffs: 健康状态缓存                                                    │
│  └─ Personality: 从 PersonaService 获取的个性                                │
│                                                                               │
│  方法:                                                                        │
│  ├─ AddTalkRequest(prompt, recipient, talkType)                             │
│  ├─ GetNextTalkRequest(): 获取下一个未过期的请求                             │
│  ├─ CanDisplayTalk(): 检查是否可以显示对话                                   │
│  ├─ CanGenerateTalk(): 检查是否可以生成新对话                                │
│  ├─ IgnoreTalkResponse(): 忽略一个对话响应                                   │
│  └─ IgnoreAllTalkResponses(): 清空对话队列                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                     TalkHistory (对话历史管理) ★ 可替换                       │
│                                                                               │
│  Per-pawn 消息历史:                                                           │
│  ├─ 存储最近的对话用于 LLM 上下文                                             │
│  ├─ 限制历史长度以控制 token 使用                                             │
│  └─ 格式: List<(Role role, string message)>                                 │
│                                                                               │
│  已说出/已忽略跟踪:                                                           │
│  ├─ _spokenTalks: Dictionary<Guid, int> (ID → tick)                         │
│  └─ _ignoredTalks: HashSet<Guid>                                            │
│                                                                               │
│  方法:                                                                        │
│  ├─ GetMessageHistory(pawn): 获取对话历史                                    │
│  ├─ AddMessageHistory(pawn, prompt, responses)                              │
│  ├─ AddSpoken(id): 标记为已说出                                             │
│  ├─ AddIgnored(id): 标记为已忽略                                            │
│  ├─ GetSpokenTick(id): 获取说出时间                                          │
│  └─ IsTalkIgnored(id): 检查是否被忽略                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      ApiHistory (API 调用历史) ★ 可替换                       │
│                                                                               │
│  用于调试和统计的 API 调用日志                                                │
│                                                                               │
│  ApiLog 记录:                                                                │
│  ├─ Id: Guid                                                                 │
│  ├─ Request: TalkRequest                                                     │
│  ├─ Instruction: 系统提示词                                                  │
│  ├─ Response: JSON 响应字符串                                                │
│  ├─ Name: 说话者名称                                                         │
│  ├─ Timestamp: 时间戳                                                        │
│  ├─ ElapsedMs: 响应时间                                                      │
│  ├─ SpokenTick: 何时显示 (-1 if ignored)                                    │
│  └─ Payload: Token 计数等                                                    │
│                                                                               │
│  方法:                                                                        │
│  ├─ AddRequest(request, instruction): 记录请求                               │
│  ├─ AddResponse(parentId, text, name, payload): 记录响应                     │
│  ├─ AddUserHistory(name, message): 记录用户输入                              │
│  ├─ GetApiLog(id): 获取日志条目                                              │
│  └─ UpdatePayload(id, payload): 更新 payload                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. 数据模型关系 (Data Model Relationships)

```
                    ┌─────────────┐
                    │    Pawn     │ (RimWorld 游戏对象)
                    └──────┬──────┘
                           │ 1:1
                           ▼
                    ┌─────────────┐
                    │  PawnState  │ (由 Cache 管理)
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         │ 1:N             │ 1:N             │ 1:N
         ▼                 ▼                 ▼
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│  TalkRequest   │  │  TalkResponse  │  │  TalkHistory   │
│  (待生成队列)   │  │  (待显示队列)   │  │  (对话历史)     │
└────────────────┘  └────────┬───────┘  └────────────────┘
                             │
                             │ N:1
                             ▼
                    ┌────────────────┐
                    │    ApiLog      │ (API 调用记录)
                    └────────────────┘

关系说明:
- 每个 Pawn 有一个 PawnState (1:1, 由 Cache 管理)
- 每个 PawnState 有多个 TalkRequest (1:N, LinkedList)
- 每个 PawnState 有多个 TalkResponse (1:N, List)
- 每个 Pawn 有一个 TalkHistory (1:1, 存储在 TalkHistory 类中)
- 每个 TalkResponse 关联一个 ApiLog (N:1, 通过 Guid Id)
```

## 5. 关键接口和数据契约 (Key Interfaces and Data Contracts)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TalkRequest (请求数据)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  TalkType TalkType         // Other, Thought, Event, User, Urgent           │
│  string Prompt             // 提示词内容                                      │
│  Pawn Initiator            // 发起者                                         │
│  Pawn Recipient            // 接收者 (可为 null)                             │
│  int MapId                 // 地图 ID                                        │
│  int CreatedTick           // 创建时间                                       │
│  bool IsMonologue          // 是否是独白                                     │
│                                                                               │
│  方法: IsExpired()          // 检查请求是否过期                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         TalkResponse (响应数据)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  Guid Id                   // 唯一标识符                                      │
│  TalkType TalkType         // 对话类型                                       │
│  string Name               // 说话者名称 (JSON 字段)                          │
│  string Text               // 对话文本 (JSON 字段)                            │
│  Guid ParentTalkId         // 父对话 ID (用于回复链)                          │
│                                                                               │
│  方法: IsReply()           // 检查是否是回复                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              Role (角色枚举)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  System     // 系统消息 (指令)                                                │
│  User       // 用户消息 (提示词)                                              │
│  Assistant  // AI 助手消息 (响应)                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                      IAIClient (LLM 客户端接口)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  Task<Payload> GetChatCompletionAsync(                                      │
│      string instruction,                                                     │
│      List<(Role, string)> messages)                                          │
│                                                                               │
│  Task<Payload> GetStreamingChatCompletionAsync<T>(                          │
│      string instruction,                                                     │
│      List<(Role, string)> messages,                                          │
│      Action<T> onDataParsed)                                                 │
│      where T : IJsonData                                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           Payload (API 响应)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  string Response           // JSON 响应字符串                                 │
│  int TokenCount            // 使用的 token 数量                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 6. 替换策略图 (Replacement Strategy)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              现有系统                                         │
└─────────────────────────────────────────────────────────────────────────────┘
         │                           │                           │
         │ 保留 (Keep)               │ 保留 (Keep)               │ 可替换 (Replace)
         ▼                           ▼                           ▼
┌─────────────────┐       ┌──────────────────┐       ┌─────────────────────┐
│ PromptService   │       │   AIService      │       │   TalkService       │
│ PawnService     │       │   AIClientFactory│       │   PawnSelector      │
│ RelationsService│       │   OpenAIClient   │       │   Cache             │
│ PersonaService  │       │   GeminiClient   │       │   PawnState         │
│                 │       │                  │       │   TalkHistory       │
│ (游戏信息提取)   │       │ (LLM 调用)        │       │   TalkRequestPool   │
└─────────────────┘       └──────────────────┘       │   ApiHistory        │
         │                           │                │                     │
         │                           │                │ (中间处理逻辑)       │
         │                           │                └─────────────────────┘
         │                           │                           │
         └───────────────┬───────────┘                           │
                         │                                       │
                         │                                       │
┌────────────────────────┴───────────────────────────────────────┴─────────────┐
│                              您的新实现                                        │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
         ┌────────────────────────────┼────────────────────────────┐
         │                            │                            │
         ▼                            ▼                            ▼
┌─────────────────┐       ┌──────────────────┐       ┌─────────────────────┐
│ 保留原始接口     │       │ 保留原始接口      │       │ 您的新逻辑          │
│                 │       │                  │       │                     │
│ 直接调用:        │       │ 直接调用:         │       │ - 优化决策逻辑      │
│ - BuildContext()│       │ - Chat()         │       │ - 智能参与者选择    │
│ - CreatePawnXX()│       │ - ChatStreaming()│       │ - 高效状态管理      │
│ - DecorateXX()  │       │ - UpdateContext()│       │ - 优先级队列        │
│ - GetPawnXX()   │       │                  │       │ - 上下文长度优化    │
└─────────────────┘       └──────────────────┘       └─────────────────────┘
```

## 7. 集成检查清单 (Integration Checklist)

```
阶段 1: 准备 (Preparation)
├─ ☐ 理解现有代码库
├─ ☐ 设置开发环境
├─ ☐ 构建原始 mod (dotnet build)
├─ ☐ 在 RimWorld 中测试原始 mod
└─ ☐ 启用调试日志并观察流程

阶段 2: 隔离 (Isolation)
├─ ☐ 创建 Facade/接口层
│   ├─ ☐ IGameInfoExtractor 包装 PromptService
│   ├─ ☐ IAIServiceClient 包装 AIService
│   └─ ☐ IConversationOrchestrator 新接口
├─ ☐ 验证所有调用通过接口
└─ ☐ 测试接口层不破坏原有功能

阶段 3: 实现 (Implementation)
├─ ☐ 实现您的对话编排逻辑
├─ ☐ 实现您的状态管理系统
├─ ☐ 实现您的队列管理系统
├─ ☐ 实现您的参与者选择逻辑
└─ ☐ 集成测试

阶段 4: 测试 (Testing)
├─ ☐ 单元测试关键组件
├─ ☐ 集成测试完整流程
├─ ☐ 游戏内测试各种场景
│   ├─ ☐ 正常对话
│   ├─ ☐ 战斗对话
│   ├─ ☐ 用户自定义对话
│   ├─ ☐ 精神崩溃对话
│   └─ ☐ 多人对话
└─ ☐ 性能基准测试

阶段 5: 优化 (Optimization)
├─ ☐ 分析性能瓶颈
├─ ☐ 优化游戏信息提取缓存
├─ ☐ 优化 API 调用频率
├─ ☐ 优化内存使用
└─ ☐ 压力测试

阶段 6: 发布 (Release)
├─ ☐ 完整文档
├─ ☐ 用户指南
├─ ☐ 兼容性测试
└─ ☐ 社区反馈收集
```

## 结论 (Conclusion)

这些流程图展示了 RimTalk 的完整数据流，从游戏事件触发到最终显示。关键要点：

1. **保留的部分** (★ 保留):
   - `PromptService` + `PawnService` - 游戏信息提取
   - `AIService` + `AIClientFactory` + Clients - LLM 调用
   - UI 组件 - 用户交互

2. **可替换的部分** (★ 可替换):
   - `TalkService` - 对话编排逻辑
   - `PawnSelector` - 参与者选择
   - `Cache` + `PawnState` - 状态管理
   - `TalkHistory` - 历史管理
   - `TalkRequestPool` - 队列管理

3. **数据契约** (保持不变):
   - `TalkRequest` - 输入
   - `TalkResponse` - 输出
   - `Role` - 消息角色
   - `TalkType` - 对话类型

通过遵循这个架构，您可以保留 RimTalk 的核心优势（丰富的游戏信息提取和灵活的 LLM 集成），同时用您的优化实现替换中间处理逻辑，实现更好的性能和功能。
